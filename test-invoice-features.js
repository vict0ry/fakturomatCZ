#!/usr/bin/env node

/**
 * Komplexn√≠ testy pro 3 nov√© invoice funkce:
 * 1. Jednotky v polo≈æk√°ch (kg, hodiny, m¬≤, atd.)
 * 2. Procentu√°ln√≠ slevy (v doplnƒõn√≠ k absolutn√≠m)
 * 3. Opakovan√© faktury
 */

import fetch from 'node-fetch';

const API_BASE = 'http://localhost:5000/api';
let authToken = '';

// Test utility functions
async function login() {
  const response = await fetch(`${API_BASE}/auth/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      username: 'admin@doklad.ai',
      password: 'admin123'
    })
  });
  
  if (!response.ok) {
    throw new Error('Login failed');
  }
  
  const data = await response.json();
  authToken = data.sessionId || data.token || data.user?.sessionId;
  console.log('‚úÖ P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©');
  return authToken;
}

async function createTestCustomer() {
  const response = await fetch(`${API_BASE}/customers`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${authToken}`
    },
    body: JSON.stringify({
      name: 'Test Firma pro nov√© funkce s.r.o.',
      email: 'test@testfirma.cz',
      ico: '12345678',
      address: 'Testovac√≠ 123',
      city: 'Praha',
      postalCode: '11000'
    })
  });
  
  if (!response.ok) {
    throw new Error('Customer creation failed');
  }
  
  const customer = await response.json();
  console.log('‚úÖ Test z√°kazn√≠k vytvo≈ôen:', customer.name);
  return customer;
}

// TEST 1: Jednotky v polo≈æk√°ch faktury
async function testInvoiceUnits() {
  console.log('\nüß™ TEST 1: Jednotky v polo≈æk√°ch faktury');
  
  const customer = await createTestCustomer();
  
  const invoiceData = {
    customerId: customer.id,
    type: 'invoice',
    issueDate: new Date().toISOString().split('T')[0],
    dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
    items: [
      {
        description: 'Konzultace',
        quantity: '8',
        unit: 'hodiny',
        unitPrice: '1500',
        vatRate: '21',
        discountType: 'none',
        discountValue: '0'
      },
      {
        description: 'Materi√°l',
        quantity: '25.5',
        unit: 'kg',
        unitPrice: '350',
        vatRate: '21',
        discountType: 'none',
        discountValue: '0'
      },
      {
        description: 'Instalace podlahy',
        quantity: '42.8',
        unit: 'm¬≤',
        unitPrice: '800',
        vatRate: '21',
        discountType: 'none',
        discountValue: '0'
      },
      {
        description: 'Balen√≠',
        quantity: '12',
        unit: 'balen√≠',
        unitPrice: '45',
        vatRate: '21',
        discountType: 'none',
        discountValue: '0'
      }
    ]
  };
  
  const response = await fetch(`${API_BASE}/invoices`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${authToken}`
    },
    body: JSON.stringify(invoiceData)
  });
  
  if (!response.ok) {
    const error = await response.text();
    throw new Error(`Invoice creation failed: ${error}`);
  }
  
  const invoice = await response.json();
  
  // Ovƒõ≈ô ≈æe jednotky jsou spr√°vnƒõ ulo≈æeny
  const expectedUnits = ['hodiny', 'kg', 'm¬≤', 'balen√≠'];
  const actualUnits = invoice.items.map(item => item.unit);
  
  expectedUnits.forEach((expectedUnit, index) => {
    if (actualUnits[index] === expectedUnit) {
      console.log(`‚úÖ Jednotka "${expectedUnit}" spr√°vnƒõ ulo≈æena`);
    } else {
      console.log(`‚ùå Jednotka "${expectedUnit}" neodpov√≠d√°: ${actualUnits[index]}`);
    }
  });
  
  console.log('üìä Celkov√© mno≈æstv√≠ testovan√Ωch jednotek:', expectedUnits.length);
  return invoice;
}

// TEST 2: Procentu√°ln√≠ slevy
async function testPercentageDiscounts() {
  console.log('\nüß™ TEST 2: Procentu√°ln√≠ slevy v polo≈æk√°ch');
  
  const customer = await createTestCustomer();
  
  const invoiceData = {
    customerId: customer.id,
    type: 'invoice',
    issueDate: new Date().toISOString().split('T')[0],
    dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
    items: [
      {
        description: 'Slu≈æba s 10% slevou',
        quantity: '1',
        unit: 'ks',
        unitPrice: '1000',
        vatRate: '21',
        discountType: 'percentage',
        discountValue: '10'
      },
      {
        description: 'Slu≈æba s 25% slevou',
        quantity: '2',
        unit: 'ks',
        unitPrice: '500',
        vatRate: '21',
        discountType: 'percentage',
        discountValue: '25'
      },
      {
        description: 'Slu≈æba s pevnou slevou 200 Kƒç',
        quantity: '1',
        unit: 'ks',
        unitPrice: '1200',
        vatRate: '21',
        discountType: 'fixed',
        discountValue: '200'
      },
      {
        description: 'Slu≈æba bez slevy',
        quantity: '1',
        unit: 'ks',
        unitPrice: '800',
        vatRate: '21',
        discountType: 'none',
        discountValue: '0'
      }
    ]
  };
  
  const response = await fetch(`${API_BASE}/invoices`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${authToken}`
    },
    body: JSON.stringify(invoiceData)
  });
  
  if (!response.ok) {
    const error = await response.text();
    throw new Error(`Invoice with discounts creation failed: ${error}`);
  }
  
  const invoice = await response.json();
  
  // Ovƒõ≈ô kalkulace slev
  const testCases = [
    { name: '10% sleva z 1000', expected: 100, item: invoice.items[0] },
    { name: '25% sleva z 1000 (2√ó500)', expected: 250, item: invoice.items[1] },
    { name: 'Pevn√° sleva 200', expected: 200, item: invoice.items[2] },
    { name: 'Bez slevy', expected: 0, item: invoice.items[3] }
  ];
  
  testCases.forEach(testCase => {
    const actualDiscount = parseFloat(testCase.item.discountAmount || 0);
    if (Math.abs(actualDiscount - testCase.expected) < 0.01) {
      console.log(`‚úÖ ${testCase.name}: ${actualDiscount} Kƒç`);
    } else {
      console.log(`‚ùå ${testCase.name}: oƒçek√°v√°no ${testCase.expected}, skuteƒçnost ${actualDiscount}`);
    }
  });
  
  return invoice;
}

// TEST 3: Opakovan√© faktury
async function testRecurringInvoices() {
  console.log('\nüß™ TEST 3: Opakovan√© faktury');
  
  const customer = await createTestCustomer();
  
  const recurringData = {
    templateName: 'Mƒõs√≠ƒçn√≠ testovac√≠ faktura',
    customerId: customer.id,
    frequency: 'monthly',
    interval: 1,
    startDate: new Date().toISOString().split('T')[0],
    endDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
    maxCount: 12,
    notes: 'Testovac√≠ opakovan√° faktura'
  };
  
  // Test vytvo≈ôen√≠ opakovan√© faktury
  const createResponse = await fetch(`${API_BASE}/invoices/recurring`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${authToken}`
    },
    body: JSON.stringify(recurringData)
  });
  
  if (!createResponse.ok) {
    const error = await createResponse.text();
    throw new Error(`Recurring invoice creation failed: ${error}`);
  }
  
  const recurringInvoice = await createResponse.json();
  console.log('‚úÖ Opakovan√° faktura vytvo≈ôena:', recurringInvoice.data?.id || recurringInvoice.id);
  
  // Test naƒçten√≠ v≈°ech opakovan√Ωch faktur
  const listResponse = await fetch(`${API_BASE}/invoices/recurring`, {
    headers: {
      'Authorization': `Bearer ${authToken}`
    }
  });
  
  if (!listResponse.ok) {
    throw new Error('Failed to fetch recurring invoices');
  }
  
  const recurringList = await listResponse.json();
  console.log('‚úÖ Naƒçteno opakovan√Ωch faktur:', recurringList.length);
  
  // Test pozastaven√≠ opakovan√© faktury
  if (recurringList.length > 0) {
    const firstRecurring = recurringList[0];
    const toggleResponse = await fetch(`${API_BASE}/invoices/recurring/${firstRecurring.id}/toggle`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({ isActive: false })
    });
    
    if (toggleResponse.ok) {
      console.log('‚úÖ Stav opakovan√© faktury √∫spƒõ≈°nƒõ zmƒõnƒõn');
    } else {
      console.log('‚ùå Chyba p≈ôi zmƒõnƒõ stavu opakovan√© faktury');
    }
  }
  
  return recurringInvoice;
}

// TEST 4: Komplexn√≠ integrace v≈°ech funkc√≠
async function testComplexIntegration() {
  console.log('\nüß™ TEST 4: Komplexn√≠ integrace v≈°ech funkc√≠');
  
  const customer = await createTestCustomer();
  
  const complexInvoiceData = {
    customerId: customer.id,
    type: 'invoice',
    issueDate: new Date().toISOString().split('T')[0],
    dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
    items: [
      {
        description: 'Programov√°n√≠ (s 15% slevou pro st√°l√© klienty)',
        quantity: '40',
        unit: 'hodiny',
        unitPrice: '1800',
        vatRate: '21',
        discountType: 'percentage',
        discountValue: '15'
      },
      {
        description: 'Serverov√Ω hardware (sleva 5000 Kƒç)',
        quantity: '2.5',
        unit: 'kg',
        unitPrice: '25000',
        vatRate: '21',
        discountType: 'fixed',
        discountValue: '5000'
      },
      {
        description: 'Kancel√°≈ôsk√Ω prostor',
        quantity: '150',
        unit: 'm¬≤',
        unitPrice: '320',
        vatRate: '21',
        discountType: 'percentage',
        discountValue: '8'
      }
    ]
  };
  
  const response = await fetch(`${API_BASE}/invoices`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${authToken}`
    },
    body: JSON.stringify(complexInvoiceData)
  });
  
  if (!response.ok) {
    const error = await response.text();
    throw new Error(`Complex invoice creation failed: ${error}`);
  }
  
  const invoice = await response.json();
  
  // Ovƒõ≈ô komplexn√≠ kalkulace
  console.log('‚úÖ Komplexn√≠ faktura vytvo≈ôena s ID:', invoice.id);
  console.log('üìä Celkov√Ω poƒçet polo≈æek:', invoice.items.length);
  console.log('üí∞ Celkov√° ƒç√°stka faktury:', invoice.total, 'CZK');
  
  // Ovƒõ≈ô ≈æe v≈°echny jednotky a slevy jsou spr√°vnƒõ
  const hasCustomUnits = invoice.items.some(item => item.unit !== 'ks');
  const hasDiscounts = invoice.items.some(item => item.discountType !== 'none');
  
  console.log(hasCustomUnits ? '‚úÖ Vlastn√≠ jednotky funguj√≠' : '‚ùå Probl√©m s jednotkami');
  console.log(hasDiscounts ? '‚úÖ Slevy funguj√≠' : '‚ùå Probl√©m se slevami');
  
  return invoice;
}

// Hlavn√≠ testovac√≠ funkce
async function runAllTests() {
  console.log('üöÄ Spou≈°t√≠m komplexn√≠ testy nov√Ωch invoice funkc√≠...\n');
  
  try {
    await login();
    
    console.log('\n=== TESTOV√ÅN√ç NOV√ùCH FUNKC√ç ===');
    
    const test1Result = await testInvoiceUnits();
    console.log(`‚úÖ TEST 1 DOKONƒåEN - Invoice ID: ${test1Result.id}`);
    
    const test2Result = await testPercentageDiscounts();
    console.log(`‚úÖ TEST 2 DOKONƒåEN - Invoice ID: ${test2Result.id}`);
    
    const test3Result = await testRecurringInvoices();
    console.log(`‚úÖ TEST 3 DOKONƒåEN - Recurring ID: ${test3Result.data?.id || test3Result.id}`);
    
    const test4Result = await testComplexIntegration();
    console.log(`‚úÖ TEST 4 DOKONƒåEN - Complex Invoice ID: ${test4Result.id}`);
    
    console.log('\nüéâ V≈†ECHNY TESTY √öSPƒö≈†Nƒö DOKONƒåENY!');
    console.log('\nüìã SOUHRN IMPLEMENTOVAN√ùCH FUNKC√ç:');
    console.log('‚úÖ 1. Jednotky v polo≈æk√°ch (hodiny, kg, m¬≤, balen√≠, atd.)');
    console.log('‚úÖ 2. Procentu√°ln√≠ slevy (% i pevn√© ƒç√°stky Kƒç)');
    console.log('‚úÖ 3. Opakovan√© faktury (mƒõs√≠ƒçnƒõ, ƒçtvrtletnƒõ, roƒçnƒõ)');
    console.log('‚úÖ 4. Komplexn√≠ integrace v≈°ech funkc√≠ souƒçasnƒõ');
    
    console.log('\nüí° SYST√âM JE P≈òIPRAVEN PRO PRODUKƒåN√ç POU≈ΩIT√ç');
    
  } catch (error) {
    console.error('\n‚ùå CHYBA V TESTECH:', error.message);
    process.exit(1);
  }
}

// Spustit testy
runAllTests();